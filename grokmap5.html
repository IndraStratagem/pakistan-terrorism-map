<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map of Pakistan with Terrorist Attacks</title>
    <!-- Leaflet CSS from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <!-- Leaflet MarkerCluster CSS from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <!-- Leaflet JS from CDN -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <!-- Leaflet MarkerCluster JS from CDN -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <!-- SheetJS (XLSX) from CDN for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Initialize the Leaflet map centered on Pakistan
        // Coordinates for center: approximately latitude 30.3753, longitude 69.3451
        // Zoom level 5 to show the whole country
        var map = L.map('map').setView([30.3753, 69.3451], 5);

        // Add OpenStreetMap tile layer
        // This provides the base map tiles with place names in English
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // Load GeoJSON for borders
        // Country (international) border
        fetch('https://raw.githubusercontent.com/glynnbird/countriesgeojson/master/pakistan.geojson')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: 'black', weight: 3, fillOpacity: 0 } // Thick black border, no fill
                }).addTo(map);
            })
            .catch(error => console.error('Error loading country GeoJSON:', error));

        // Provinces borders
        fetch('https://raw.githubusercontent.com/PakData/GISData/master/PAK-GeoJSON/PAK_adm1.json')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: 'blue', weight: 2, fillOpacity: 0 } // Blue borders for provinces
                }).addTo(map);
            })
            .catch(error => console.error('Error loading provinces GeoJSON:', error));

        // Districts borders
        fetch('https://raw.githubusercontent.com/PakData/GISData/master/PAK-GeoJSON/PAK_adm3.json')
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: 'gray', weight: 1, dashArray: '5,5', fillOpacity: 0 } // Dashed gray borders for districts
                }).addTo(map);
            })
            .catch(error => console.error('Error loading districts GeoJSON:', error));

        // Function to load and parse the Excel file
        // Assumes the Excel file is named 'terrorist_attacks_pakistan.xlsx' and is in the same directory
        // The file should have columns: Date, City, Province, Description, Deaths_Gov, Deaths_Terr, Injuries, Latitude, Longitude, Terrorist_Group
        // Only includes data for terrorist attacks after the Taliban takeover of Kabul (August 15, 2021)
        // User needs to populate this file with data from reliable sources like Wikipedia or SATP
        fetch('terrorist_attacks_pakistan.xlsx')
            .then(response => response.arrayBuffer())
            .then(data => {
                // Read the Excel file using SheetJS
                var workbook = XLSX.read(data, { type: 'array' });
                // Get the first sheet
                var sheetName = workbook.SheetNames[0];
                var sheet = workbook.Sheets[sheetName];
                // Convert sheet to JSON array of objects
                var jsonData = XLSX.utils.sheet_to_json(sheet);

                // Objects to hold layer groups for provinces and terrorist groups
                var provinceLayers = {};
                var groupLayers = {};
                var overlays = {};

                // Iterate over each row in the data
                jsonData.forEach(function(row) {
                    // Check if latitude and longitude are present
                    if (row.Latitude && row.Longitude) {
                        // Create tooltip content with incident details
                        var tooltipContent = `
                            <b>Date:</b> ${row.Date || 'N/A'}<br>
                            <b>City:</b> ${row.City || 'N/A'}<br>
                            <b>Province:</b> ${row.Province || 'N/A'}<br>
                            <b>Description:</b> ${row.Description || 'N/A'}<br>
                            <b>Deaths (Gov):</b> ${row.Deaths_Gov || 'N/A'}<br>
                            <b>Deaths (Terr):</b> ${row.Deaths_Terr || 'N/A'}<br>
                            <b>Injuries:</b> ${row.Injuries || 'N/A'}<br>
                            <b>Latitude:</b> ${row.Latitude}<br>
                            <b>Longitude:</b> ${row.Longitude}<br>
                            <b>Terrorist Group:</b> ${row.Terrorist_Group || 'Unknown'}
                        `;

                        // Get province and terrorist group
                        var province = row.Province || 'Unknown';
                        var terrGroup = row.Terrorist_Group || 'Unknown';

                        // For province layer
                        if (!provinceLayers[province]) {
                            provinceLayers[province] = L.markerClusterGroup();
                            overlays['Province: ' + province] = provinceLayers[province];
                        }
                        var markerProv = L.marker([row.Latitude, row.Longitude]);
                        markerProv.bindTooltip(tooltipContent);
                        provinceLayers[province].addLayer(markerProv);

                        // For terrorist group layer (duplicate marker)
                        if (!groupLayers[terrGroup]) {
                            groupLayers[terrGroup] = L.markerClusterGroup();
                            overlays['Group: ' + terrGroup] = groupLayers[terrGroup];
                        }
                        var markerGroup = L.marker([row.Latitude, row.Longitude]);
                        markerGroup.bindTooltip(tooltipContent);
                        groupLayers[terrGroup].addLayer(markerGroup);
                    }
                });

                // Add layer control to the map
                // Layers are not added by default; user can toggle them on
                L.control.layers(null, overlays).addTo(map);
            })
            .catch(error => {
                console.error('Error loading or parsing Excel file:', error);
                // Optional: Add a message on the map if file fails to load
                L.popup()
                    .setLatLng([30.3753, 69.3451])
                    .setContent('Error loading data. Please ensure "terrorist_attacks_pakistan.xlsx" is available and properly formatted.')
                    .openOn(map);
            });
    </script>
</body>
</html>