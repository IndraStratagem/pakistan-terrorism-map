<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map of Terrorist Attacks in Pakistan</title>
    <!-- Leaflet CSS from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <!-- Leaflet MarkerCluster CSS from CDN -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <!-- Leaflet JS from CDN -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <!-- Leaflet MarkerCluster JS from CDN -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <!-- SheetJS (XLSX) from CDN for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        #map { height: 600px; width: 100%; }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        // Initialize the Leaflet map centered on Pakistan
        // Coordinates for center: approximately latitude 30.3753, longitude 69.3451
        // Zoom level 5 to show the whole country
        var map = L.map('map').setView([30.3753, 69.3451], 5);

        // Add OpenStreetMap tile layer as base map
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        // Base maps (only one for simplicity)
        var baseMaps = {
            "OpenStreetMap": osm
        };

        // Object to hold province-based cluster groups
        var provinceGroups = {};

        // Function to load and parse the Excel file
        // Assumes the Excel file is named 'terrorist_attacks_pakistan.xlsx' and is in the same directory
        // The file should have columns: Date, Location, City, Province, Year, Terrorist_Group, Latitude, Longitude, Government_Deaths, Terrorist_Deaths, Injuries, Description, Perpetrator
        // Data for attacks after Taliban takeover of Kabul (August 15, 2021)
        fetch('terrorist_attacks_pakistan.xlsx')
            .then(response => response.arrayBuffer())
            .then(data => {
                // Read the Excel file using SheetJS
                var workbook = XLSX.read(data, { type: 'array' });
                // Get the first sheet
                var sheetName = workbook.SheetNames[0];
                var sheet = workbook.Sheets[sheetName];
                // Convert sheet to JSON array of objects
                var jsonData = XLSX.utils.sheet_to_json(sheet);

                // Process each row
                jsonData.forEach(function(row) {
                    // Check if latitude and longitude are present
                    if (row.Latitude && row.Longitude) {
                        // Determine province or use 'Unknown'
                        var province = row.Province || 'Unknown';

                        // Create or get the marker cluster group for this province
                        if (!provinceGroups[province]) {
                            provinceGroups[province] = L.markerClusterGroup();
                        }

                        // Create a marker
                        var marker = L.marker([row.Latitude, row.Longitude]);

                        // Bind tooltip for hover (message box with date and deaths)
                        marker.bindTooltip(`
                            <b>Date:</b> ${row.Date || 'N/A'}<br>
                            <b>Deaths (Government):</b> ${row.Government_Deaths || 'N/A'}<br>
                            <b>Deaths (Terrorists):</b> ${row.Terrorist_Deaths || 'N/A'}
                        `, { sticky: true });

                        // Bind popup for click (more details)
                        var popupContent = `
                            <b>Date:</b> ${row.Date || 'N/A'}<br>
                            <b>Location:</b> ${row.Location || 'N/A'}<br>
                            <b>City:</b> ${row.City || 'N/A'}<br>
                            <b>Province:</b> ${row.Province || 'N/A'}<br>
                            <b>Year:</b> ${row.Year || 'N/A'}<br>
                            <b>Terrorist Group:</b> ${row.Terrorist_Group || row.Perpetrator || 'Unknown'}<br>
                            <b>Deaths (Government):</b> ${row.Government_Deaths || 'N/A'}<br>
                            <b>Deaths (Terrorists):</b> ${row.Terrorist_Deaths || 'N/A'}<br>
                            <b>Injuries:</b> ${row.Injuries || 'N/A'}<br>
                            <b>Description:</b> ${row.Description || 'N/A'}
                        `;
                        marker.bindPopup(popupContent);

                        // Add marker to the province's cluster group
                        provinceGroups[province].addLayer(marker);
                    }
                });

                // Create overlays object for layer control
                var overlays = {};
                for (var prov in provinceGroups) {
                    overlays[prov] = provinceGroups[prov];
                }

                // Add layer control to the map
                L.control.layers(baseMaps, overlays).addTo(map);

                // Add all province groups to the map initially
                for (var prov in provinceGroups) {
                    provinceGroups[prov].addTo(map);
                }
            })
            .catch(error => {
                console.error('Error loading or parsing Excel file:', error);
                // Optional: Add a message on the map if file fails to load
                L.popup()
                    .setLatLng([30.3753, 69.3451])
                    .setContent('Error loading data. Please ensure "terrorist_attacks_pakistan.xlsx" is available and correctly formatted.')
                    .openOn(map);
            });
    </script>
</body>
</html>